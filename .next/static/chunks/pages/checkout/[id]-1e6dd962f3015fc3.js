(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[414],{3116:(e,t,a)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/checkout/[id]",function(){return a(8416)}])},8416:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>u});var o=a(7876),c=a(9099),r=a(4232),s=a(7274),i=a(1423),n=a(6184),l=a(8615),d=a(1950);function u(){let{user:e,loading:t}=(0,n.A)(),a=(0,c.useRouter)(),{id:u}=a.query,[h,p]=(0,r.useState)(null),[m,g]=(0,r.useState)({nome:"",email:"",telefone:""}),[f,x]=(0,r.useState)(""),[k,v]=(0,r.useState)(""),[b,j]=(0,r.useState)(null),[N,y]=(0,r.useState)("pendente"),[_,w]=(0,r.useState)(null),[S,E]=(0,r.useState)(null),[P,q]=(0,r.useState)(null),[C,I]=(0,r.useState)(!1),[T,R]=(0,r.useState)(null),[B,O]=(0,r.useState)(null),[A,D]=(0,r.useState)(null),[z,W]=(0,r.useState)(null);(0,r.useEffect)(()=>{t||e||a.replace("/login")},[e,t,a]),(0,r.useEffect)(()=>{s.N.auth.getUser().then(e=>{var t;let{data:a}=e;R((null==a||null==(t=a.user)?void 0:t.id)||null)});let e=localStorage.getItem("pushinpay_api_key");e&&w(e)},[]),(0,r.useEffect)(()=>{u&&e&&(async()=>{try{let{data:t,error:o}=await s.N.from("products").select("*").eq("id",u).single();if(o)throw o;if(!t)throw Error("Produto n\xe3o encontrado");if(t.user_id!==e.id)return void a.replace("/acesso-negado");if(p(t),R(t.user_id),t.user_id){let{data:e}=await s.N.from("integrations").select("pixel_id").eq("user_id",t.user_id).eq("provider","facebook_pixel").single();(null==e?void 0:e.pixel_id)&&O(e.pixel_id)}}catch(e){console.error("Erro ao carregar checkout:",e),p(null)}})()},[u,e,a]),(0,r.useEffect)(()=>{var e,t,a,o,c,r;if(!B||!h||document.getElementById("fb-pixel-script"))return;e=window,t=document,a="script",e.fbq||(o=e.fbq=function(){o.callMethod?o.callMethod.apply(o,arguments):o.queue.push(arguments)},e._fbq||(e._fbq=o),o.push=o,o.loaded=!0,o.version="2.0",o.queue=[],(c=t.createElement(a)).async=!0,c.id="fb-pixel-script",c.src="https://connect.facebook.net/en_US/fbevents.js",(r=t.getElementsByTagName(a)[0]).parentNode.insertBefore(c,r)),window.fbq("init",B),window.fbq("track","PageView");let s=Number(h.price);s>1e3&&(s/=100),window.fbq("track","InitiateCheckout",{currency:"BRL",value:s})},[B,h]),(0,r.useEffect)(()=>(document.body.classList.add("checkout-page"),()=>document.body.classList.remove("checkout-page")),[]);let M=e=>{g({...m,[e.target.name]:e.target.value})},L=async e=>{if(e&&e.preventDefault(),x(""),v(""),!m.nome||!m.email||!m.telefone)return void x("Preencha todos os campos!");if(b)return void await $();let t=(0,i.A)();j(t);let{data:a,error:o}=await s.N.from("checkout_logs").insert({log_id:t,product_id:h.id,user_id:h.user_id,price:h.price,checkout_url:window.location.href,status:"pendente",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),nome:m.nome,email:m.email,telefone:m.telefone}).select().single();if(o)return void x("Erro ao registrar checkout.");y("pendente"),v("Dados enviados! Gerando pagamento..."),await $(t)},$=async e=>{let t=e||b;if(!t)return void x("Preencha e envie o formul\xe1rio antes de pagar!");if(!_)return void x("Chave de API n\xe3o encontrada.");x(""),v(""),I(!0);try{let e=Math.round(100*Number(h.price));if(!e||isNaN(e)||e<=0){x("Valor do produto inv\xe1lido."),I(!1);return}let a=await fetch("https://api.pushinpay.com.br/api/pix/cashIn",{method:"POST",headers:{Authorization:"Bearer ".concat(_),Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({value:e,webhook_url:"".concat(window.location.origin,"/api/webhook")})}),o=await a.json();if(console.log("PushinPay response:",o),!a.ok){x(o.error||o.message||JSON.stringify(o)||"Erro ao gerar cobran\xe7a."),I(!1);return}if(o.id&&o.qr_code){if(D(o.qr_code),v("Pagamento gerado! Copie o c\xf3digo Pix abaixo e pague no seu banco."),q(o.id),!t||"string"!=typeof t||t.length<10){x("Erro interno: logId inv\xe1lido."),I(!1);return}await s.N.from("checkout_logs").update({status:"pendente",transaction_id:o.id}).eq("log_id",t),G(o.id)}else x("Erro ao gerar cobran\xe7a.")}catch(e){x("Erro ao conectar com PushinPay.")}I(!1)},G=async e=>{if(!_)return;let t=0,o=setInterval(async()=>{t++;let c=await fetch("https://api.pushinpay.com.br/api/transactions/".concat(e),{method:"GET",headers:{Authorization:"Bearer ".concat(_),Accept:"application/json","Content-Type":"application/json"}}),r=await c.json();if("approved"===r.status||"paid"===r.status){y("aprovado"),v("Pagamento aprovado!");let{error:e,data:t}=await s.N.from("checkout_logs").update({status:"approved",updated_at:new Date().toISOString()}).eq("log_id",b).select().single();e&&console.error("Erro ao aprovar o log de checkout:",e),clearInterval(o),a.push("/checkout/obrigado")}else t>30&&clearInterval(o)},3e3)};return t?(0,o.jsxs)("div",{className:"checkout-loading",children:[(0,o.jsx)("div",{className:"checkout-spinner"}),"Carregando..."]}):h?(0,o.jsxs)("div",{className:"checkout-container",children:[z&&(0,o.jsx)("div",{className:"checkout-banner-image",style:{width:"100%",display:"flex",justifyContent:"center",marginBottom:18},children:(0,o.jsx)("img",{src:z,alt:"Banner do Checkout",style:{maxWidth:380,width:"100%",borderRadius:14,boxShadow:"0 2px 16px #0002"}})}),(0,o.jsxs)("div",{className:"checkout-banner",children:["Oferta por Tempo Limitado!",(0,o.jsx)(function(){let[e,t]=(0,r.useState)(466);(0,r.useEffect)(()=>{if(e<=0)return;let a=setInterval(()=>t(e=>e-1),1e3);return()=>clearInterval(a)},[e]);let a=String(Math.floor(e/60)).padStart(2,"0"),c=String(e%60).padStart(2,"0");return(0,o.jsxs)("div",{className:"checkout-timer",children:[(0,o.jsxs)("div",{className:"checkout-timer-box",children:["0",(0,o.jsx)("br",{}),(0,o.jsx)("span",{className:"checkout-timer-label",children:"HORAS"})]}),(0,o.jsxs)("div",{className:"checkout-timer-box",children:[a,(0,o.jsx)("br",{}),(0,o.jsx)("span",{className:"checkout-timer-label",children:"MIN"})]}),(0,o.jsxs)("div",{className:"checkout-timer-box",children:[c,(0,o.jsx)("br",{}),(0,o.jsx)("span",{className:"checkout-timer-label",children:"SEG"})]})]})},{})]}),(0,o.jsxs)("div",{className:"checkout-card checkout-card-pro",children:[h.imagem_url&&(0,o.jsx)("img",{src:h.imagem_url,alt:h.name,className:"checkout-product-img"}),(0,o.jsx)("div",{className:"checkout-title",children:h.name}),(0,o.jsxs)("div",{className:"checkout-upsell",children:[(0,o.jsxs)("div",{className:"checkout-upsell-title",children:[(0,o.jsx)(l.usP,{color:"#facc15"})," Voc\xea tamb\xe9m pode gostar de:"]}),(0,o.jsxs)("div",{className:"checkout-upsell-product",children:[(0,o.jsx)("div",{style:{fontWeight:600},children:"Produto Extra"}),(0,o.jsx)("div",{style:{fontSize:"0.97rem",color:"#444"},children:"Um produto voltando para voce consguir da capa em seus inimigos"}),(0,o.jsx)("div",{style:{color:"#22c55e",fontWeight:700,marginTop:4},children:"+ R$ 12,00"}),(0,o.jsx)("div",{style:{color:"#22c55e",fontWeight:700,marginTop:2},children:"+ R$ 12,00"}),(0,o.jsxs)("div",{style:{marginTop:6},children:[(0,o.jsx)("input",{type:"checkbox",className:"checkout-upsell-checkbox"})," Quero comprar tamb\xe9m!"]})]})]}),(0,o.jsxs)("div",{className:"checkout-summary",children:[(0,o.jsxs)("div",{className:"checkout-summary-row",children:[(0,o.jsx)("span",{children:"teste"}),(0,o.jsx)("span",{style:{color:"#22c55e"},children:"+R$ 12,00"})]}),(0,o.jsxs)("div",{className:"checkout-summary-total",children:[(0,o.jsx)("span",{children:"Total"}),(0,o.jsx)("span",{children:"R$ 12,00"})]})]})]}),(0,o.jsxs)("div",{className:"checkout-form-card checkout-form-card-pro",children:[(0,o.jsx)("div",{className:"checkout-form-title",children:"Preencha suas informa\xe7\xf5es pra envio do produto."}),(0,o.jsx)("input",{name:"email",type:"email",value:m.email,onChange:M,className:"checkout-input checkout-input-pro",placeholder:"Digite seu e-mail",required:!0}),(0,o.jsx)("input",{name:"nome",value:m.nome,onChange:M,className:"checkout-input checkout-input-pro",placeholder:"Digite seu nome completo",required:!0}),(0,o.jsx)("input",{name:"telefone",value:m.telefone,onChange:M,className:"checkout-input checkout-input-pro",placeholder:"Digite seu telefone/WhatsApp",required:!0}),(0,o.jsx)("div",{className:"checkout-form-title",style:{marginTop:12,marginBottom:6},children:"Formas de pagamento"}),(0,o.jsxs)("div",{className:"checkout-payment-box checkout-payment-box-pro",children:[(0,o.jsx)("span",{style:{fontSize:"1.2em",marginRight:8},children:"âš¡"})," Pix"]}),f&&(0,o.jsx)("div",{className:"checkout-message error checkout-message-pro",children:f}),k&&(0,o.jsxs)("div",{className:"checkout-message success checkout-message-pro",children:[(0,o.jsx)(l.A3x,{style:{marginRight:6}})," ",k]}),(0,o.jsx)("button",{onClick:L,className:"checkout-btn checkout-btn-pro",disabled:C,children:C?"Processando...":"Pagar agora"}),A&&(0,o.jsxs)("div",{className:"checkout-qrcode checkout-qrcode-pro",children:[(0,o.jsx)("div",{className:"checkout-qrcode-label",children:"Escaneie o QR Code ou copie o Pix:"}),(0,o.jsx)(d.X,{value:A,size:180,bgColor:"#fff",fgColor:"#2563eb",style:{marginBottom:12,borderRadius:12,boxShadow:"0 2px 12px #2563eb22"}}),(0,o.jsx)("textarea",{className:"checkout-pix-code checkout-pix-code-pro",value:A,readOnly:!0,style:{width:"100%",minHeight:60,borderRadius:8,padding:8,fontSize:14,marginBottom:8}}),(0,o.jsx)("button",{className:"checkout-btn checkout-btn-copy",style:{marginTop:8,background:"#22c55e",color:"#111",fontWeight:700},onClick:()=>{navigator.clipboard.writeText(A),v("C\xf3digo Pix copiado!")},type:"button",children:"Copiar c\xf3digo Pix"})]})]})]}):(0,o.jsx)("div",{className:"checkout-loading",children:"Produto n\xe3o encontrado."})}}},e=>{var t=t=>e(e.s=t);e.O(0,[141,377,636,593,792],()=>t(3116)),_N_E=e.O()}]);